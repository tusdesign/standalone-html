name: Build and push harbor

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      target_deployment:
        description: 'Target Deployment'
        required: true
        default: 'dev'
        type: choice
        options:
          - "dev"
          - "staging"
          - "prod"
  push:
    # branches:
    #   - main
    tags:
      - 'v.[0-9]+.[0-9]+.[0-9]+'      

jobs:
  build:
    runs-on: [ubuntu-latest]
    # runs-on: [self-hosted, macOS, ARM64]
    steps:
    - uses: actions/checkout@v3
      with:
        persist-credentials: false
    - name: Set none latest env
      if: github.event.inputs.target_deployment != ''
      run: echo "TAG_VERSION=${{ github.event.inputs.target_deployment }}" >> $GITHUB_ENV
    - name: Set latest env
      if: github.event.inputs.target_deployment == ''
      run: echo "TAG_VERSION=latest" >> $GITHUB_ENV
    - name: Run build and push docker to harbor
      run: sh ./scripts/build_harbor.sh
      env:
        VERSION: ${{ env.TAG_VERSION }}
        COMMIT_SHA: ${{ github.sha }}
        HARBOR_USER: ${{ secrets.HARBOR_USER }}
        HARBOR_PASS: ${{ secrets.HARBOR_PASS }}
